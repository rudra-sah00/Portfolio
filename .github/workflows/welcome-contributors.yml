name: Welcome Contributors

on:
  pull_request_target:
    types: [opened]

permissions:
  pull-requests: write
  issues: write

jobs:
  welcome:
    name: Welcome First-Time Contributors
    runs-on: ubuntu-latest

    steps:
      - name: Check if first-time contributor
        uses: actions/github-script@v7
        with:
          script: |
            const creator = context.payload.pull_request.user.login;

            // Get all PRs by this user
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: creator
            });

            // If this is their first PR
            if (prs.length === 1) {
              // Check if welcome comment already exists
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              
              const hasWelcomeComment = comments.some(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('Welcome @' + creator)
              );
              
              // Only post if no welcome comment exists
              if (!hasWelcomeComment) {
                const welcomeMessage = `ðŸ‘‹ Welcome @${creator}!
                
                Thank you for your first contribution to this project! ðŸŽ‰
                
                Here's what happens next:
                1. âœ… Automated checks will run on your PR
                2. ðŸ‘€ A maintainer will review your changes
                3. ðŸ’¬ They may request changes or approve
                4. ðŸŽŠ Once approved, your PR will be merged!
                
                Feel free to ask questions if you need help. We're here to support you! ðŸš€`;
                
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: welcomeMessage
                });
                
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['first-time contributor']
                });
              }
            }
