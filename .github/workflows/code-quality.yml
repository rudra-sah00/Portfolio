name: Code Quality Analysis

on:
  pull_request:
    branches: [develop, production]
  push:
    branches: [develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Shallow clones should be disabled for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Analyze code complexity
        run: |
          echo "## ðŸ“Š Code Complexity Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Metrics:" >> $GITHUB_STEP_SUMMARY
          echo "- Lines of Code: $(find src -name '*.ts' -o -name '*.tsx' | xargs wc -l | tail -1 | awk '{print $1}')" >> $GITHUB_STEP_SUMMARY
          echo "- Number of Files: $(find src -name '*.ts' -o -name '*.tsx' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Test Coverage: $(cat coverage/coverage-summary.json | jq '.total.statements.pct')%" >> $GITHUB_STEP_SUMMARY

      - name: Check for TODOs and FIXMEs
        run: |
          echo "## ðŸ“ TODOs and FIXMEs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          TODO_COUNT=$(grep -r "TODO\|FIXME\|XXX\|HACK" src --include="*.ts" --include="*.tsx" | wc -l || echo "0")
          echo "Found $TODO_COUNT TODO/FIXME comments" >> $GITHUB_STEP_SUMMARY

          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Details:" >> $GITHUB_STEP_SUMMARY
            grep -rn "TODO\|FIXME\|XXX\|HACK" src --include="*.ts" --include="*.tsx" | head -20 >> $GITHUB_STEP_SUMMARY || true
          fi
        continue-on-error: true

      - name: Check for console logs
        run: |
          echo "## ðŸ› Console Logs Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          CONSOLE_COUNT=$(grep -r "console\\.log" src --include="*.ts" --include="*.tsx" | wc -l || echo "0")
          if [ "$CONSOLE_COUNT" -gt 0 ]; then
            echo "âš ï¸ Found $CONSOLE_COUNT console.log statements (should be removed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No console.log statements found" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true
