name: PR Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  pr-metadata:
    name: PR Metadata Check
    runs-on: ubuntu-latest

    steps:
      - name: Check PR title
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const validPrefixes = ['feat:', 'fix:', 'docs:', 'style:', 'refactor:', 'test:', 'chore:', 'perf:', 'ci:', 'build:'];
            const hasValidPrefix = validPrefixes.some(prefix => title.toLowerCase().startsWith(prefix));

            if (!hasValidPrefix) {
              core.setFailed(`PR title should start with one of: ${validPrefixes.join(', ')}`);
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âš ï¸ **Invalid PR Title**
                
                Please use one of these prefixes for your PR title:
                - \`feat:\` - New feature
                - \`fix:\` - Bug fix
                - \`docs:\` - Documentation changes
                - \`style:\` - Code style changes
                - \`refactor:\` - Code refactoring
                - \`test:\` - Test changes
                - \`chore:\` - Maintenance tasks
                - \`perf:\` - Performance improvements
                - \`ci:\` - CI/CD changes
                - \`build:\` - Build system changes
                
                Example: \`feat: add new dashboard component\``
              });
            } else {
              console.log('âœ… PR title is valid');
            }

      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const changedFiles = pr.changed_files;
            const totalChanges = additions + deletions;

            let size = 'small';
            let emoji = 'ðŸŸ¢';

            if (totalChanges > 1000 || changedFiles > 20) {
              size = 'large';
              emoji = 'ðŸ”´';
            } else if (totalChanges > 500 || changedFiles > 10) {
              size = 'medium';
              emoji = 'ðŸŸ¡';
            }

            console.log(`PR size: ${size} ${emoji}`);
            console.log(`Total changes: ${totalChanges} (${additions} additions, ${deletions} deletions)`);
            console.log(`Changed files: ${changedFiles}`);

            // Add size label
            const labels = ['size: small', 'size: medium', 'size: large'];
            const currentLabels = pr.labels.map(l => l.name);
            const labelsToRemove = labels.filter(l => currentLabels.includes(l));

            // Remove old size labels
            for (const label of labelsToRemove) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: label
              }).catch(() => {});
            }

            // Add new size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [`size: ${size}`]
            });

  auto-label:
    name: Auto Label PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Label based on changed files
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const labels = new Set();

            files.forEach(file => {
              const path = file.filename;
              
              // Component changes
              if (path.includes('components/')) labels.add('component');
              
              // Test changes
              if (path.includes('__tests__') || path.includes('.test.') || path.includes('.spec.')) {
                labels.add('tests');
              }
              
              // Documentation
              if (path.endsWith('.md')) labels.add('documentation');
              
              // API changes
              if (path.includes('/api/')) labels.add('api');
              
              // Styling
              if (path.endsWith('.css') || path.endsWith('.scss')) labels.add('styling');
              
              // TypeScript/Types
              if (path.endsWith('.ts') || path.endsWith('.tsx')) labels.add('typescript');
              
              // Configuration
              if (path.includes('config') || path.includes('.config.')) labels.add('configuration');
              
              // CI/CD
              if (path.includes('.github/workflows')) labels.add('ci/cd');
              
              // Dependencies
              if (path.includes('package.json') || path.includes('package-lock.json')) {
                labels.add('dependencies');
              }
            });

            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: Array.from(labels)
              });
              
              console.log(`Added labels: ${Array.from(labels).join(', ')}`);
            }

  pr-welcome:
    name: Welcome First-Time Contributors
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'

    steps:
      - name: Check if first-time contributor
        uses: actions/github-script@v7
        with:
          script: |
            const creator = context.payload.pull_request.user.login;

            // Get all PRs by this user
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: creator
            });

            // If this is their first PR
            if (prs.length === 1) {
              // Check if welcome comment already exists
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              
              const hasWelcomeComment = comments.some(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('Welcome @' + creator)
              );
              
              // Only post if no welcome comment exists
              if (!hasWelcomeComment) {
                const welcomeMessage = `ðŸ‘‹ Welcome @${creator}!
                
                Thank you for your first contribution to this project! ðŸŽ‰
                
                Here's what happens next:
                1. âœ… Automated checks will run on your PR
                2. ðŸ‘€ A maintainer will review your changes
                3. ðŸ’¬ They may request changes or approve
                4. ðŸŽŠ Once approved, your PR will be merged!
                
                Feel free to ask questions if you need help. We're here to support you! ðŸš€`;
                
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: welcomeMessage
                });
              }
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['first-time contributor']
              });
            }
